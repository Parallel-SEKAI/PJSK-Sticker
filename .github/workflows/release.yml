name: Flutter Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build Flutter ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform: [Android, Linux, Windows]
        include:
          - platform: Android
            os: ubuntu-latest
          - platform: Linux
            os: ubuntu-latest
          - platform: Windows
            os: windows-latest

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.1"

      # 仅在编译 Linux 时安装必要的系统库
      - name: Install Linux dependencies
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts libgtk-3-dev libblkid-dev liblzma-dev libgcrypt20-dev imagemagick

      - name: Install dependencies
        run: flutter pub get

      # Android 专属步骤：解码 Keystore
      - name: Decode Keystore
        if: matrix.platform == 'Android'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-keystore.jks

      - name: Create key.properties
        if: matrix.platform == 'Android'
        run: |
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=release-keystore.jks" >> android/key.properties

      # 编译步骤
      - name: Build Android APKs
        if: matrix.platform == 'Android'
        run: flutter build apk --release --split-per-abi

      - name: Build Windows executable
        if: matrix.platform == 'Windows'
        run: flutter build windows --release

      - name: Build Linux executable
        if: matrix.platform == 'Linux'
        run: flutter build linux --release

      - name: Build Linux AppImage
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get install -y libfuse2
          convert assets/icon.png -resize 256x256! pjsk_sticker.png
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          mkdir -p AppDir/usr/bin
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          echo "[Desktop Entry]
          Name=PJSK Sticker
          Exec=pjsk_sticker
          Icon=pjsk_sticker
          Type=Application
          Categories=Utility;" > pjsk_sticker.desktop
          ./linuxdeploy-x86_64.AppImage --appimage-extract-and-run --appdir AppDir -i pjsk_sticker.png -d pjsk_sticker.desktop --output appimage
          cp *.AppImage ${{ github.workspace }}/PJSK_Sticker-x86_64.AppImage

      # 打包压缩步骤
      - name: Archive Windows build artifact
        if: matrix.platform == 'Windows'
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release -DestinationPath ${{ github.workspace }}/windows-release.zip
        shell: pwsh

      - name: Archive Linux build artifact
        if: matrix.platform == 'Linux'
        run: |
          cd build/linux/x64/release/bundle
          tar -czvf ${{ github.workspace }}/linux-release.tar.gz .

      # 上传 Artifacts
      - name: Upload Android APK artifacts
        if: matrix.platform == 'Android'
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/apk/release/*.apk

      - name: Upload Windows artifact
        if: matrix.platform == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release.zip

      - name: Upload Linux artifact
        if: matrix.platform == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            linux-release.tar.gz
            PJSK_Sticker-x86_64.AppImage

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts
          merge-multiple: true

      - name: Determine if prerelease
        id: pre
        run: |
          if [[ "${GITHUB_REF_NAME}" == *"-rc"* ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          name: PJSK Sticker ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ steps.pre.outputs.is_prerelease }}
          files: build-artifacts/*
